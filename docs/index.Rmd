---
title: "OzCoViz"
date: "`r lubridate::now()`"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    social: ["menu"]
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(lubridate)
library(EpiEstim)
library(patchwork)
library(gganimate)
# devtools::install_github('emitanaka/datalegreyar')
library(datalegreyar)
library(memoise)

knitr::opts_chunk$set(cache = FALSE)
```

```{r center-covid-from-100}
selected_countries <- c(
                        "Australia",
                        "China",
                        "Italy",
                        "Singapore",
                        "United_Kingdom",
                        "United_States_of_America",
                        "South_Korea",
                        # "Canada",
                        "Germany", 
                        "Japan",
                        # "Iran",
                        "Spain",
                        "France")
                        # "Denmark"
```


```{r pull-data}
yesterday <- today() - 1L

covid <- covid_latest() %>% 
  filter(date < yesterday) %>% 
  filter(country_region %in% selected_countries) 

```


```{r covid-changepoint}
covid_changepoint <- covid %>% 
  add_covid_change_point() %>% 
  filter(date >= change_point_date)
```

```{r load-nsw-funcs, cache=FALSE}
source(here::here("docs/get_nsw_data.R"))
source(here::here("docs/get_nishiura_si_sample.R"))
suppressMessages({
source(here::here("docs/plot_nsw_eff_r.R"))
})
```

```{r prep-nsw-data-and-plots, cache=FALSE}
source(here::here("docs/nsw_eff_R_data_and_plot_prep.R"))
```

Overview
=======================================================================

```{r}
# this just takes teh last 21 days of Australian data, Ideally it should show the 
# whole history of Australian data since, say 1st March 2020

vals <- covid %>%
          filter(country_region == "Australia") %>%
          arrange(date) %>%
          top_n(25, wt=row_number()) %>%
          pull(cases)

maxpos <- which(vals == max(vals))
if (all(vals[maxpos] > vals[18:25])) {
  fig(datafy(vals, "oz covid19 visualisations", ignore_space=FALSE), size=60,
      symbol=setNames(c(maxpos, 18:24), c("max", rep("down",7))))
} else {
  fig(datafy(vals, "oz covid19 visualisations", ignore_space=FALSE), size=60,
      symbol=setNames(c(maxpos, 18:24), c("max", rep("up",7))))
}
    
```

The time-series line in the heading above is derived from current incidence cases of COVID-19 in Australia.

Column  {.tabset}
-----------------------------------------------------------------------

### Overview

### Contributors

These graphics are licensed with a [CC BY-NC-SA License](https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode)

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

Users must provide personal and institutional acknowledgement on reuse

In turn, we acknowledge RECON, and EuroCDC

Project has been led by [Timothy Churches](), [Nicholas Tierney](), with thanks to [Stuart Lee](), [Dianne Cook](), and [Miles McBain]()



Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

Source code for this visualisation are available at [covid-flexdashboard](https://github.com/CBDRH/covid-flexdashboard)

### Technical Details

Analysis used includes:

- Use

Packages used include:

- flexdashboard
- tidyverse
- readr
- tibble
- dplyr
- tidyr
- stringr
- lubridate
- magrittr
- countrycode
- janitor
- stats
- scales
- readxl
- httr
- glue
- purrr
- rlang
- ggplot2
- EpiEstim
- changepoint
- ggrepel
- vctrs
- memoise


Incidence {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Explanation

### Cumulative Incidence for selected countries

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)

```

```{r gg-cumulative-incidence}

gg_covid_cumulative_exceed_limit(covid_since_100,
                                 limit = 100) + 
  theme(panel.grid.minor = element_blank()) 
  # ggthemes::scale_colour_colorblind() +
  # annotation_logticks(sides = "l") 
```


### Australian incidence

```{r oz-cases}
library(glue)
covid_since_100_au <- covid_since_100 %>% 
  filter(geo_id == "AU") 
  
oz_cases_max_date <- format(max(covid_since_100_au$date), "%d %B %Y")
oz_cases_min_date <- format(min(covid_since_100_au$date), "%d %B %Y")

gg_cases <- ggplot(covid_since_100_au,
       aes(x = date,
           y = cases)) + 
  geom_col(fill = "black") + 
  theme_minimal() +
  labs(title = "COVID-19 epidemic case incidence",
       subtitle = glue(
         "For Australia from {oz_cases_min_date} to {oz_cases_max_date}"
       ),
       x = "Date since cumulative cases exceeded 100",
       y = "New Cases",
       caption = "CC BY-NC-SA
               Tim Churches (UNSW)
               Nick Tierney (Monash)
               Data source: European CDC")

gg_cases
  
```

### Australian incidence (semi-log)

```{r oz-cases-log10}
gg_cases +
   scale_y_log10() +
  theme(panel.grid.minor = element_blank()) +
  # annotation_logticks() + 
  labs(y = "New Cases (Log Scale")
  
```


National-level $R_{t}$ {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Explanation

### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid_changepoint)
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}
gg_effective_repro_all(covid_instant_r) + 
  # ggthemes::scale_colour_colorblind() +
  theme(panel.grid.minor = element_blank())
  # annotation_logticks() 
```


### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
gg_effective_repro_facet(covid_instant_r)  + 
  # ggthemes::scale_colour_colorblind() + 
  theme(panel.grid.minor = element_blank())
  # annotation_logticks() 
```


$R_{t}$ for NSW {.storyboard}
=======================================================================

### Explanation


---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>parametric serial interval distribution

```{r, fig.width=10, fig.height=10}
A1a / A2a / A3a / A4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>serial interval distribution estimated from data

```{r, fig.width=10, fig.height=10}
A1b / A2b / A3b / A4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>parametric serial interval distribution

```{r, fig.width=10, fig.height=10}
B1a / B2a / B3a / B4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>serial interval distribution estimated from data

```{r, fig.width=10, fig.height=10}
B1b / B2b / B3b / B4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---


### **NSW -- all cases treated as locally-acquired**<br>parametric serial interval distribution

```{r, fig.width=10, fig.height=10,}
C1a / C2a / C3a + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---

### **NSW -- all cases treated as locally-acquired**<br>serial interval distribution estimated from data

```{r, fig.width=10, fig.height=10,}
C1b / C2b / C3b + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---




