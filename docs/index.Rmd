---
title: "Covid19 data"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(vegawidget)
knitr::opts_chunk$set(cache = FALSE)
```

```{r pull-data}
covid <- covid_latest()
```

```{r center-covid-from-100}
selected_countries <- c("China",
                        "Singapore",
                        "Japan",
                        "Iran",
                        "Italy",
                        "Spain",
                        "US",
                        "United_Kingdom",
                        "Australia",
                        "France",
                        "South_Korea")
```

```{r covid-filter}
covid_subset <- covid %>% 
  filter(country_region %in% c(selected_countries, 
                               "United_States_of_America", 
                               "Germany", 
                               "Denmark"))
```


```{r covid-changepoint}
covid_changepoint <- covid_subset %>% 
  add_covid_change_point() %>% 
  filter(date >= change_point_date)
```


Cumulative 
=======================================================================

### Cumulative Incidence

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)
```

```{r filter}
covid_since_100_selected <- covid_since_100 %>% 
  filter(country_region %in% selected_countries)
```

```{r gg-cumulative-incidence, eval = FALSE}
gg_covid_cumulative_exceed_limit(covid_since_100_selected, 
                                 limit = 100)
```


```{r vl-cumulative-incidence}
vl_line_plot <- 
  list(
    data = list(values = covid_since_100_selected %>% 
                  select(days_since_limit, cumulative_cases, country_region)
    ),
    mark = list(type = "line", tooltip = TRUE),
    encoding = list(
      x = list(field = "days_since_limit", 
               type = "quantitative",
               axis = list(title = "Days since cumulative cases exceeded 100")),
      y = list(field = "cumulative_cases", 
               type = "quantitative",
               scale = list(type = "log"),
               axis = list(title = "Cumulative cases (logarithmic scale)",
                           tickCount = 5,
                           tickExtra = FALSE)),
      color = list(field = "country_region",
                   type = "nominal",
                   axis = list(title = "Country"),
                   legend = NA)
    )
  )

max_days_offset <- max(covid_since_100_selected$days_since_limit) + 10
vl_text_repel <- 
  list(
    data = list(values = covid_since_100_selected %>% 
                  group_by(geo_id) %>% 
                  filter(date == last(date)) %>% 
                  ungroup() %>% 
                  select(days_since_limit, cumulative_cases, country_region)),
    mark = list(type = "text", dx = 5, baseline = "middle",
                align = "left", clip = TRUE),
    encoding = list(
      x = list(field = "days_since_limit", 
               type = "quantitative",
               scale = list(domain = list(0, max_days_offset))),
      y = list(field = "cumulative_cases", type = "quantitative"),
      color = list(field = "country_region", type = "nominal", legend = NA),
      text = list(field = "country_region", type = "nominal")
    )
  )

vl_covid_cumulative_exceed_limit <- 
  list(
    `$schema` = vega_schema(),
    width = 600,
    height = 400,
    layer = list(vl_line_plot)
  ) 

vl_covid_cumulative_exceed_limit %>% 
  as_vegaspec()
```


Instant Effective Reproduction {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid_changepoint)
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}

gg_effective_repro_all(covid_instant_r)

```

### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
gg_effective_repro_facet(covid_instant_r) 
```


Case Doubling
=======================================================================

```{r gg-case-doubling}

```


About
=======================================================================

These graphics are licensed with a CC BY-NC-SA License
Users must provide personal and institutional acknowledgement on reuse

Analysis used includes ...

Packages used ...

In turn, we acknowledge RECON, and EuroCDC

Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

