---
title: "Covid19 data"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    logo: flex_icon.png
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(lubridate)
library(EpiEstim)
library(patchwork)

knitr::opts_chunk$set(cache = FALSE)
```

```{r center-covid-from-100}
selected_countries <- c(
                        "Australia",
                        "China",
                        "Italy",
                        "Singapore",
                        "United_Kingdom",
                        "United_States_of_America",
                        "South_Korea",
                        # "Canada",
                        "Germany", 
                        "Japan",
                        # "Iran",
                        "Spain",
                        "France")
                        # "Denmark"
```


```{r pull-data}
yesterday <- today() - 1L

covid <- covid_latest() %>% 
  filter(date < yesterday) %>% 
  filter(country_region %in% selected_countries) 

```


```{r covid-changepoint}
covid_changepoint <- covid %>% 
  add_covid_change_point() %>% 
  filter(date >= change_point_date)
```

Home
=======================================================================


Cumulative {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Cumulative Incidence

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)

```

```{r gg-cumulative-incidence}

gg_covid_cumulative_exceed_limit(covid_since_100,
                                 limit = 100) + 
  theme(panel.grid.minor = element_blank()) 
  # ggthemes::scale_colour_colorblind() +
  # annotation_logticks(sides = "l") 
```

### Explanation

Cases {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Oz Cases

```{r oz-cases}
library(glue)
covid_since_100_au <- covid_since_100 %>% 
  filter(geo_id == "AU") 
  
oz_cases_max_date <- format(max(covid_since_100_au$date), "%d %B %Y")
oz_cases_min_date <- format(min(covid_since_100_au$date), "%d %B %Y")

gg_cases <- ggplot(covid_since_100_au,
       aes(x = date,
           y = cases)) + 
  geom_col(fill = "black") + 
  theme_minimal() +
  labs(title = "COVID-19 epidemic case incidence",
       subtitle = glue(
         "For Australia from {oz_cases_min_date} to {oz_cases_max_date}"
       ),
       x = "Date since cumulative cases exceeded 100",
       y = "New Cases",
       caption = "CC BY-NC-SA
               Tim Churches (UNSW)
               Nick Tierney (Monash)
               Data source: European CDC")

gg_cases
  
```

### Oz Cases (log10)

```{r oz-cases-log10}
gg_cases +
   scale_y_log10() +
  theme(panel.grid.minor = element_blank()) +
  # annotation_logticks() + 
  labs(y = "New Cases (Log Scale")
  
```

### Explanation

IER {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid_changepoint)
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}
gg_effective_repro_all(covid_instant_r) + 
  ggthemes::scale_colour_colorblind() +
  theme(panel.grid.minor = element_blank())
  # annotation_logticks() 
```

### Explanation

Effective R (Per country) {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
gg_effective_repro_facet(covid_instant_r)  + 
  ggthemes::scale_colour_colorblind() + 
  theme(panel.grid.minor = element_blank())
  # annotation_logticks() 
```

### Explanation

Effective R (NSW) {.storyboard}
=======================================================================

```{r load-nsw-funcs, cache=FALSE}
source("docs/get_nsw_data.R")
source("docs/get_nishiura_si_sample.R")
source("docs/plot_nsw_eff_r.R")
```

```{r get-nsw-data, cache=FALSE}
nsw_incidence <- get_nsw_data()

nsw_incidence_total <- nsw_incidence %>%
  mutate(dates=notification_date,
         I=OS + LC + LNC + UIX) %>%
  select(dates, I)

nsw_incidence_split_incl_uix <- nsw_incidence %>%
  mutate(dates=notification_date,
         imported=OS,
         local= LC + LNC + UIX) %>%
  select(dates, imported, local)

nsw_incidence_split_excl_uix <- nsw_incidence %>%
  mutate(dates=notification_date,
         imported=OS,
         local= LC + LNC) %>%
  select(dates, imported, local)
         
```

```{r get-si-sample, message=FALSE, include=FALSE, cache=FALSE}
nishi_si_sample <- get_nishiura_si_sample()
```

```{r estimate-R-configs, cache=FALSE}
# SI distribution from Nishiura et al.
parametric_si_nishiura_config <- make_config(list(mean_si = 4.7,
                                         std_si = 2.9))

# values from https://www.nejm.org/doi/full/10.1056/NEJMoa2001316
parametric_si_li_config <- make_config(list(mean_si = 7.5,
                                         std_si = 3.4))

# posterior sample based on Nishiura et al SI data
si_from_sample_nishiura_config <-  make_config(list(n1=500, n2 = 50, seed=2))
```


```{r}
nsw_effr_total_para_si <- estimate_R(nsw_incidence_total,
                                     method="parametric_si",
                                     config = parametric_si_li_config)
```

```{r}
nsw_effr_total_si_from_sample <- estimate_R(nsw_incidence_total,
                            method="si_from_sample",
                            si_sample=nishi_si_sample,
                            config = si_from_sample_nishiura_config)
```

```{r}
nsw_effr_split_incl_uix_para_si <- estimate_R(nsw_incidence_split_incl_uix,
                                      method="parametric_si",
                                      config = parametric_si_li_config)
```

```{r}
nsw_effr_split_incl_uix_si_from_sample <- estimate_R(nsw_incidence_split_incl_uix,
                            method="si_from_sample",
                            si_sample=nishi_si_sample,
                            config = si_from_sample_nishiura_config)
```

```{r}
nsw_effr_split_excl_uix_para_si <- estimate_R(nsw_incidence_split_excl_uix,
                                      method="parametric_si",
                                      config = parametric_si_li_config)
```

```{r}
nsw_effr_split_excl_uix_si_from_sample <- estimate_R(nsw_incidence_split_excl_uix,
                            method="si_from_sample",
                            si_sample=nishi_si_sample,
                            config = si_from_sample_nishiura_config)
```

```{r}
plots_A <- plot_Ri(parametric_si_obj=nsw_effr_split_excl_uix_para_si,
                 si_from_sample_obj=nsw_effr_split_excl_uix_si_from_sample,
                 split=TRUE)

A1a <- plots_A$p_R_parametric_si +
  scale_y_log10(limits=c(0.25, 10)) +
  labs(title=expression("7-day sliding window effective reproduction number R"[t]),
       subtitle=paste0("Local & overseas sources of infection treated separately\n",
                       "Parametric serial interval distribution"))

A1b <- plots_A$p_R_si_from_sample +
  scale_y_log10(limits=c(0.25, 10)) +
  labs(title=expression("7-day sliding window effective reproduction number R"[t]),
       subtitle=paste0("Local & overseas sources of infection treated separately\n",
                       "Serial interval distribution estimated from data"))

A2a <- plots_A$p_I_loc +
    # ylim(0, plots_A$max_I) +
    labs(title="Incidence: cases with local sources of infection",
          subtitle="(excluding under investigation)")

A2b <- plots_A$p_I_loc +
    # ylim(0, plots_A$max_I) +
    labs(title="Incidence: cases with local sources of infection",
          subtitle="(excluding under investigation)")

A3a <- plots_A$p_I_imp +
    # ylim(0, plots_A$max_I) +
    labs(title="Incidence: cases with overseas sources of infection")

A3b <- plots_A$p_I_imp +
    # ylim(0, plots_A$max_I) +
    labs(title="Incidence: cases with overseas sources of infection")

A4a <- plots_A$p_SI_parametric_si +
  xlim(0,25) +
  labs(title="Explored parametric serial interval distribution",
       subtitle=expression(paste("from parameters given by Li ", italic("et al."))),
       caption=paste("CC BY", # '\U1F16D','\U1F16F',
                     "Tim Churches, UNSW Medicine &\n",
                     "Nick Tierney, Monash University"))

A4b <- plots_A$p_SI_si_from_sample +
  xlim(0,25) +
  labs(title="Explored serial interval posterior estimates",
       subtitle=expression(paste("from data given by Nishiura ", italic("et al."))),
       caption=paste("CC BY", # '\U1F16D','\U1F16F',
                     "Tim Churches, UNSW Medicine &\n",
                     "Nick Tierney, Monash University"))

# icon for flexdashboard
flex_icon <- plots_A$p_R_parametric_si +
   xlim(ymd("2020-03-09"),NA) +
   labs(title=NULL,
        subtitle=NULL,
        caption=NULL) +
   theme_void()
   
```


```{r}
plots_B <- plot_Ri(parametric_si_obj=nsw_effr_split_incl_uix_para_si,
                 si_from_sample_obj=nsw_effr_split_incl_uix_si_from_sample,
                 split=TRUE)

B1a <- plots_B$p_R_parametric_si +
  scale_y_log10(limits=c(0.25, 10)) +
  labs(title=expression("7-day sliding window effective reproduction number R"[t]),
       subtitle=paste0("Local & overseas sources of infection treated separately\n",
                       "Parametric serial interval distribution"))

B1b <- plots_B$p_R_si_from_sample +
  scale_y_log10(limits=c(0.25, 10)) +
  labs(title=expression("7-day sliding window effective reproduction number R"[t]),
       subtitle=paste0("Local & overseas sources of infection treated separately\n",
                       "Serial interval distribution estimated from data"))

B2a <- plots_B$p_I_loc +
    # ylim(0, plots_B$max_I) +
    labs(title="Incidence: cases with local sources of infection",
         subtitle="(including under investigation)")

B2b <- plots_B$p_I_loc +
    # ylim(0, plots_B$max_I) +
    labs(title="Incidence: cases with local sources of infection",
          subtitle="(including under investigation)")

B3a <- plots_B$p_I_imp +
    # ylim(0, plots_B$max_I) +
    labs(title="Incidence: cases with overseas sources of infection")

B3b <- plots_B$p_I_imp +
    # ylim(0, plots_B$max_I) +
    labs(title="Incidence: cases with overseas sources of infection")

B4a <- plots_B$p_SI_parametric_si +
  xlim(0,25) +
  labs(title="Explored parametric serial interval distribution",
       subtitle=expression(paste("from parameters given by Li ", italic("et al."))),
       caption=paste("CC BY", # '\U1F16D','\U1F16F',
                     "Tim Churches, UNSW Medicine &\n",
                     "Nick Tierney, Monash University"))

B4b <- plots_B$p_SI_si_from_sample +
  xlim(0,25) +
  labs(title="Explored serial interval posterior estimates",
       subtitle=expression(paste("from data given by Nishiura ", italic("et al."))),
       caption=paste("CC BY", # '\U1F16D','\U1F16F',
                     "Tim Churches, UNSW Medicine &\n",
                     "Nick Tierney, Monash University"))
```

```{r}
plots_C <- plot_Ri(parametric_si_obj=nsw_effr_total_para_si,
                  si_from_sample_obj=nsw_effr_total_si_from_sample)

C1a <- plots_C$p_R_parametric_si +
  labs(title=expression("7-day sliding window effective reproduction number R"[t]),
       subtitle=paste0("All sources of infection treated as local\n",
                       "Parametric serial interval distribution"))

C1b <- plots_C$p_R_si_from_sample +
  labs(title=expression("7-day sliding window effective reproduction number R"[t]),
       subtitle=paste0("All sources of infection treated as local,\n",
                       "Serial interval distribution estimated from data"))

C2a <- plots_C$p_I +
  labs(title="Incidence: all sources of infection",
       subtitle="(local, imported and under investigation)")
  
C2b <- plots_C$p_I +
  labs(title="Incidence: all sources of infection",
       subtitle="(local, imported and under investigation)")

C3a <- plots_C$p_SI_parametric_si +
  xlim(0,25) +
  labs(title="Explored parametric serial interval distribution",
       subtitle=expression(paste("from parameters given by Li ", italic("et al."))),
       caption=paste("CC BY", # '\U1F16D','\U1F16F',
                     "Tim Churches, UNSW Medicine &\n",
                     "Nick Tierney, Monash University"))
  
C3b <- plots_C$p_SI_si_from_sample +
  xlim(0,25) +
  labs(title="Explored serial interval posterior estimates",
       subtitle=expression(paste("from data given by Nishiura ", italic("et al."))),
       caption=paste("CC BY", # '\U1F16D','\U1F16F',
                     "Tim Churches, UNSW Medicine &\n",
                     "Nick Tierney, Monash University"))
```

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>parametric serial interval distribution

```{r, fig.width=10, fig.height=10}
A1a / A2a / A3a / A4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>serial interval distribution estimated from data

```{r, fig.width=10, fig.height=10}
A1b / A2b / A3b / A4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>parametric serial interval distribution

```{r, fig.width=10, fig.height=10}
B1a / B2a / B3a / B4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>serial interval distribution estimated from data

```{r, fig.width=10, fig.height=10}
B1b / B2b / B3b / B4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---


### **NSW -- all cases treated as locally-acquired**<br>parametric serial interval distribution

```{r, fig.width=10, fig.height=10,}
C1a / C2a / C3a + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---

### **NSW -- all cases treated as locally-acquired**<br>serial interval distribution estimated from data

```{r, fig.width=10, fig.height=10,}
C1b / C2b / C3b + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---

### Explanation

```{r}
ggsave("docs/flex_icon.png", plot=flex_icon,
       units="in", dpi="retina",
       height=48/320, width=(48/320)*2)

```

---

Contributors
=======================================================================

These graphics are licensed with a [CC BY-NC-SA License](https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode)

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

Users must provide personal and institutional acknowledgement on reuse

In turn, we acknowledge RECON, and EuroCDC

Project has been led by [Timothy Churches](), [Nicholas Tierney](), with thanks to [Stuart Lee](), [Dianne Cook](), and [Miles McBain]()



Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

Source code for this visualisation are available at [covid-flexdashboard](https://github.com/CBDRH/covid-flexdashboard)

Technical Details
=======================================================================

Analysis used includes:

- Use

Packages used include:

- flexdashboard
- tidyverse
- readr
- tibble
- dplyr
- tidyr
- stringr
- lubridate
- magrittr
- countrycode
- janitor
- stats
- scales
- readxl
- httr
- glue
- purrr
- rlang
- ggplot2
- EpiEstim
- changepoint
- ggrepel
- vctrs
- memoise


