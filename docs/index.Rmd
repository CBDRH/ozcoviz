---
title: "Covid19 data"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    # logo: images/unsw.png
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(lubridate)
library(EpiEstim)

knitr::opts_chunk$set(cache = FALSE)
```

```{r center-covid-from-100}
selected_countries <- c(
                        "Australia",
                        "China",
                        "Italy",
                        "Singapore",
                        "United_Kingdom",
                        "United_States_of_America",
                        "South_Korea",
                        # "Canada",
                        "Germany", 
                        "Japan",
                        # "Iran",
                        "Spain",
                        "France")
                        # "Denmark"
```


```{r pull-data}
covid <- covid_latest() %>% 
  filter(date < dmy("30-03-2020")) %>% 
  filter(country_region %in% selected_countries) 

```


```{r covid-changepoint}
covid_changepoint <- covid %>% 
  add_covid_change_point() %>% 
  filter(date >= change_point_date)
```

Home
=======================================================================


Cumulative {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Cumulative Incidence

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)
```

```{r gg-cumulative-incidence}

gg_covid_cumulative_exceed_limit(covid_since_100,
                                 limit = 100) + 
  ggthemes::scale_colour_colorblind()
```

### Explanation

Cases {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Oz Cases

```{r oz-cases}
library(glue)
covid_since_100_au <- covid_since_100 %>% 
  filter(geo_id == "AU") 
  
oz_cases_max_date <- format(max(covid_since_100_au$date), "%d %B %Y")
oz_cases_min_date <- format(min(covid_since_100_au$date), "%d %B %Y")

ggplot(covid_since_100_au,
       aes(x = date,
           y = cases)) + 
  geom_col(fill = "black") + 
  theme_minimal() +
  labs(title = "COVID-19 epidemic case incidence",
       subtitle = glue(
         "For Australia from {oz_cases_min_date} to {oz_cases_max_date}"
       ),
       x = "Date since cumulative cases exceeded 100",
       y = "Cases (Log scale)",
       caption = "CC BY-NC-SA
               Tim Churches (UNSW)
               Nick Tierney (Monash)
               Data source: European CDC") + 
  scale_y_log10()
  
```

### Explanation

IER {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid_changepoint)
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}
gg_effective_repro_all(covid_instant_r) + 
  ggthemes::scale_colour_colorblind()
```

### Explanation

IER (Per country) {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
gg_effective_repro_facet(covid_instant_r)  + 
  ggthemes::scale_colour_colorblind()
```

### Explanation

IER (NSW) {.tabset}
=======================================================================

```{r load-nsw-funcs, cache=FALSE}
source("docs/get_nsw_data.R")
source("docs/get_nishiura_si_sample.R")
source("docs/plot_nsw_eff_r.R")
```

```{r get-nsw-data, cache=FALSE}
nsw_incidence <- get_nsw_data()

nsw_incidence_total <- nsw_incidence %>%
  mutate(dates=notification_date,
         I=OS + LC + LNC + UIX) %>%
  select(dates, I)

nsw_incidence_split_incl_uix <- nsw_incidence %>%
  mutate(dates=notification_date,
         imported=OS,
         local= LC + LNC + UIX) %>%
  select(dates, imported, local)

nsw_incidence_split_excl_uix <- nsw_incidence %>%
  mutate(dates=notification_date,
         imported=OS,
         local= LC + LNC) %>%
  select(dates, imported, local)
         
```

```{r get-si-sample, message=FALSE, include=FALSE, cache=FALSE}
nishi_si_sample <- get_nishiura_si_sample()
```

```{r estimate-R-configs, cache=FALSE}
# SI distribution from Nishiura et al.
parametric_si_nishiura_config <- make_config(list(mean_si = 4.7,
                                         std_si = 2.9))

# values from https://www.nejm.org/doi/full/10.1056/NEJMoa2001316
parametric_si_li_config <- make_config(list(mean_si = 7.5,
                                         std_si = 3.4))

# posterior sample based on Nishiura et al SI data
si_from_sample_nishiura_config <-  make_config(list(n1=500, n2 = 50, seed=2))
```


```{r}
nsw_effr_total_para_si <- estimate_R(nsw_incidence_total,
                                     method="parametric_si",
                                     config = parametric_si_li_config)
```

```{r}
nsw_effr_total_si_from_sample <- estimate_R(nsw_incidence_total,
                            method="si_from_sample",
                            si_sample=nishi_si_sample,
                            config = si_from_sample_nishiura_config)
```

```{r}
nsw_effr_split_incl_uix_para_si <- estimate_R(nsw_incidence_split_incl_uix,
                                      method="parametric_si",
                                      config = parametric_si_li_config)
```

```{r}
nsw_effr_split_incl_uix_si_from_sample <- estimate_R(nsw_incidence_split_incl_uix,
                            method="si_from_sample",
                            si_sample=nishi_si_sample,
                            config = si_from_sample_nishiura_config)
```

```{r}
nsw_effr_split_excl_uix_para_si <- estimate_R(nsw_incidence_split_excl_uix,
                                      method="parametric_si",
                                      config = parametric_si_li_config)
```

```{r}
nsw_effr_split_excl_uix_si_from_sample <- estimate_R(nsw_incidence_split_excl_uix,
                            method="si_from_sample",
                            si_sample=nishi_si_sample,
                            config = si_from_sample_nishiura_config)
```

Column  {.tabset}
-----------------------------------------------------------------------

### NSW - all data

```{r}
plots <- plot_Ri(parametric_si_obj=nsw_effr_total_para_si,
                  si_from_sample_obj=nsw_effr_total_si_from_sample,
                  title="All cases (local and imported)",
                  subtitle="Parametric serial interval distribution from Li et al.")
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots$p_R_parametric_si
plots$p_R_si_from_sample
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots$p_I
plots$p_I
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots$p_SI_parametric_si
plots$p_SI_si_from_sample
```

### NSW - local only incl under investigation

```{r}
plots_b <- plot_Ri(parametric_si_obj=nsw_effr_split_incl_uix_para_si,
                 si_from_sample_obj=nsw_effr_split_incl_uix_si_from_sample,
                 split=TRUE,
                 title="All cases (local and imported)",
                 subtitle="Parametric serial interval distribution from Li et al.")
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_b$p_R_parametric_si
plots_b$p_R_si_from_sample
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_b$p_I_loc
plots_b$p_I_loc
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_b$p_I_imp
plots_b$p_I_imp
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_b$p_SI_parametric_si
plots_b$p_SI_si_from_sample
```

### NSW - local only excl under investigation

```{r}
plots_c <- plot_Ri(parametric_si_obj=nsw_effr_split_excl_uix_para_si,
                 si_from_sample_obj=nsw_effr_split_excl_uix_si_from_sample,
                 split=TRUE,
                 title="All cases (local and imported)",
                 subtitle="Parametric serial interval distribution from Li et al.")
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_c$p_R_parametric_si
plots_c$p_R_si_from_sample
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_c$p_I_loc
plots_c$p_I_loc
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_c$p_I_imp
plots_c$p_I_imp
```

```{r, fig.width=6, fig.height=3, fig.hold="hold", out.width="50%"}
plots_c$p_SI_parametric_si
plots_c$p_SI_si_from_sample
```

### Explanation


Contributors
=======================================================================

These graphics are licensed with a [CC BY-NC-SA License](https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode)

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

Users must provide personal and institutional acknowledgement on reuse

In turn, we acknowledge RECON, and EuroCDC

Project has been led by [Timothy Churches](), [Nicholas Tierney](), with thanks to [Stuart Lee](), [Dianne Cook](), and [Miles McBain]()



Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

Source code for this visualisation are available at [covid-flexdashboard](https://github.com/CBDRH/covid-flexdashboard)

Technical Details
=======================================================================

Analysis used includes:

- Use

Packages used include:

- flexdashboard
- tidyverse
- readr
- tibble
- dplyr
- tidyr
- stringr
- lubridate
- magrittr
- countrycode
- janitor
- stats
- scales
- readxl
- httr
- glue
- purrr
- rlang
- ggplot2
- EpiEstim
- changepoint
- ggrepel
- vctrs
- memoise


