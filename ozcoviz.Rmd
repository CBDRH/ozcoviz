---
title: "OzCoViz"
date: "`r lubridate::now()`"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    social: ["menu"]
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(lubridate)
library(EpiEstim)
library(patchwork)
library(gganimate)
# devtools::install_github('emitanaka/datalegreyar')
library(datalegreyar)
library(memoise)

knitr::opts_chunk$set(cache = FALSE)
```

```{r center-covid-from-100}
selected_countries <- c(
                        "Australia",
                        "China",
                        "Italy",
                        "Singapore",
                        "United_Kingdom",
                        "United_States_of_America",
                        "South_Korea",
                        "New_Zealand",
                        # "Canada",
                        "Germany", 
                        "Japan",
                        # "Iran",
                        "Spain",
                        "France")
                        # "Denmark"
```


```{r pull-data}
yesterday <- today() - 1L

covid <- covid_latest() %>% 
#   filter(date < yesterday) %>% 
  filter(country_region %in% selected_countries) %>% 
  mutate(country_region = case_when(
    country_region == "United_States_of_America" ~ "USA",
    country_region == "United_Kingdom" ~ "UK",
    TRUE ~ country_region
    )
    )

```


```{r covid-changepoint}
covid_changepoint <- covid %>% 
  add_covid_change_point() %>% 
  filter(date >= change_point_date)
```

```{r load-nsw-funcs, cache=FALSE, include = FALSE}
source("get_nsw_data.R")
source("get_nishiura_si_sample.R")
source("plot_nsw_eff_r.R")
```

```{r prep-nsw-data-and-plots, cache=FALSE, include = FALSE}
source("nsw_eff_R_data_and_plot_prep.R")
```

Overview
=======================================================================

```{r datalegreyar, fig.align='center'}
# this just takes the last 21 days of Australian data, Ideally it should show the 
# whole history of Australian data since, say 1st March 2020

vals <- covid %>%
          filter(country_region == "Australia") %>%
          arrange(date) %>%
          top_n(25, wt = row_number()) %>%
          pull(cases)

maxpos <- which(vals == max(vals))
if (all(vals[maxpos] > vals[18:25])) {
  fig(datafy(values = vals, 
             text = "oz covid19 visualisations", 
             ignore_space = TRUE), 
      size=60,
      symbol = setNames(c(maxpos, 18:24), 
                        c("max", rep("down",7))))
} else {
  fig(datafy(values = vals, 
             text = "oz covid19 visualisations", 
             ignore_space = TRUE), 
      size = 60,
      symbol = setNames(c(maxpos, 18:24), 
                        c("max", rep("up",7))))
}
    
```

The time-series line in the heading above is derived from current incidence cases of COVID-19 in Australia.

Column  {.tabset}
-----------------------------------------------------------------------

### Introduction

This web site is a joint effort of researchers at the [South Western Sydney Clinical School](https://swscs.med.unsw.edu.au) and the [Centre for Big Data Research in Health](https://cbdrh.med.unsw.edu.au) at the [UNSW Faculty of Medicine](https://med.unsw.edu.au), the [Econometrics and Business Statistics Research Group](https://research.monash.edu/en/organisations/econometrics-business-statistics) of [Monash University](https://www.monash.edu/), and at the [Ingham Institute for Applied Medical Research](https://inghaminstitute.org.au) in Liverpool, Sydney. 

```{r, out.width="20%", fig.show='hold', out.extra='style="padding:25px"'}
knitr::include_graphics(path=here::here("assets/cbdrh_logo.png"))
knitr::include_graphics(path=here::here("assets/unsw_logo.png"))
knitr::include_graphics(path=here::here("assets/monash-logo-mono.png"))
knitr::include_graphics(path=here::here("assets/ingham_logo.png"))
```

```{r, out.width="20%", fig.align="right", eval=FALSE}
knitr::include_graphics(path=here::here("assets/cbdrh_logo.png"))
```

The intent is to offer a range of principled epidemiological and statistical analyses and visualisations of current COVID-19 data which go beyond the now ubiquitous [world maps and cumulative incidence charts](https://coronavirus.jhu.edu/map.html). 

The broad themes for the analyses and visualisations currently available are listed in the menu at the top of this page -- more will be added in due course. For each theme there is an introductory page explaining the motivating ideas and methodology employed for each of the visualisations or analyses for that theme, which are available in the subsequent frames (the series of rectangles at the top of each page). Additional notes or commentary appear on the right of some pages.

#### An Australian focus with an international perspective

This site has been created by researchers at Australian universities, and hence the focus is on the situation in Australia, within the broader international context -- we are, after all, all in this together. However, we hope that some of the analyses and visualisations on this site might be useful elsewhere, and to that end, all the [`R`](https://www.r-project.org) source code used to create this site if freely available -- please see the _Technical details_ tab above for details on software used, and where to find the source code. 

### Contributors

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />The content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. If you wish to re-use any of the content, please retain the attribution which appears on each chart or set of charts, or otherwise provide that attribution alongside the content that you re-use.

In turn, we acknowledge [RECON](https://www.repidemicsconsortium.org/) for providing financial support, and [European Centre for Disease Control](https://www.ecdc.europa.eu/en) who have provided [up to date data](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide) on the COVID19 pandemic.

Project has been led by [Timothy Churches](https://timchurches.github.io/blog/about.html), [Nicholas Tierney](https://www.njtierney.com/), with thanks to [Stuart Lee](https://stuartlee.org/), [Dianne Cook](http://dicook.org/), [Miles McBain](https://github.com/MilesMcBain), and [Rob Hyndman](https://robjhyndman.com/)

Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

Source code for this visualisation are available at [covid-flexdashboard](https://github.com/CBDRH/covid-flexdashboard)

### Technical Details

Data Analysis has been entirely created within the [R programming language](https://cran.r-project.org/) using [Rstudio](https://rstudio.com/).

Packages used include:

- [flexdashboard](https://cran.r-project.org/web/packages/flexdashboard)
- [tidyverse](https://cran.r-project.org/web/packages/tidyverse)
- [magrittr](https://cran.r-project.org/web/packages/magrittr)
- [countrycode](https://cran.r-project.org/web/packages/countrycode)
- [janitor](https://cran.r-project.org/web/packages/janitor)
- [scales](https://cran.r-project.org/web/packages/scales)
- [readxl](https://cran.r-project.org/web/packages/readxl)
- [httr](https://cran.r-project.org/web/packages/httr)
- [glue](https://cran.r-project.org/web/packages/glue)
- [EpiEstim](https://cran.r-project.org/web/packages/EpiEstim)
- [changepoint](https://cran.r-project.org/web/packages/changepoint)
- [ggrepel](https://cran.r-project.org/web/packages/ggrepel)
- [memoise](https://cran.r-project.org/web/packages/memoise)
- [patchwork](https://cran.r-project.org/web/packages/patchwork)
- [datalegreyar](https://github.com/emitanaka/datalegreyar)
- [memoise](https://cran.r-project.org/web/packages/)


Incidence {.storyboard}
=======================================================================

### Explanation

Incidence is the epidemiological term for the number of cases of a disease meeting some case definition in a specified time period. Here we present the daily incidence -- that is, the number of new cases each day -- of COVID-19 for a range of countries, including Australia, of course. Each country may be using a slightly different case definition, although most of the countries presented here have been using case definitions aligned with those [recommended by the WHO](https://www.who.int/publications-detail/global-surveillance-for-human-infection-with-novel-coronavirus-(2019-ncov)). Three types of case definition are used, simultaneously:

* **Suspected cases**
* **Probable cases**
* **Confirmed (by laboratory test) cases**

All of the data reported here are for **confirmed cases**, with a few exceptions (China included cases diagnosed via lung CT scan for a few days in Februrary, 20020, but we have adjusted the data for those days as far as possible to remove that anomaly.

The data are drawn from the [European CDC](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide), which has collected data from various governing agencies around the world. There are some small discrepancies between these data and those given by the Australian government, and indeed other national governemnst, due to timing issues relating to when cases are tabulated each day, and so on. However, we ebelive the the European CDC to be teh best source of automatically downloadable, machine-readable data there is right now.

Note, however, that because the **confirmed** case definition depends on laboratory confirmation, it is influenced by the number of lab tests (RT-PCR, reverse transcriptase polymerase chain reaction tests on nasopharyngeal swabs or sputum) done by each reporting country or jurisdiction. Obviously the number of reported cases is bounded by the number of such labs tests which are done, but the degree of under-ascertainment is also affected by the policies in place which determine which potential COVID-19 cases are tested. These policies are completely country-specific and have changed over time.

Another issue with these data is that it is vastly preferrable to analyse incidence by (presumed or definite) date of onset of symptoms, rather than by date of notification or date of reporting. Theer may be variable delays in the processing of laboratory tests and the reporting of cases to central authorities. Tabulation of incidence counts by date of onset overcomes this problem. Almost all national and jurisdictional health authorities will be collecting data on presumed date of onset for each case (although, inexplicably, it is **not** one of the data items on the [WHO-recommended data collection form](https://apps.who.int/iris/bitstream/handle/10665/331234/WHO-2019-nCoV-SurveillanceCRF-2020.2-eng.pdf)). One reason for not using date of onset is that it may be incomplete, but this ignores the fact that statistical imputation can be used to validly fill in those missing dates of onset. There are also a body of methods, collectively known as _nowcasting_, that use multivariate time-series models to convert data tabulated by date of notification/reporting to (estimated) date of onset. If national or jurisdictional health authorities do not have the technical capacity to undertake such value-adding to their own data, they should make the required data available to trusted partners in the academic sector who can undertake such statistical manipulation for them (or help authorities implement such processing internally).

** Cumulative Incidence**

Cumulative incidence is, as the name suggests, just the cumulative sum of the daily incidence - that is, a running total of the number of cases. Reporting of cumulative COVID-19 seems to dominate the mainstream media, but it has many disadvantages. In particular, a cumulative sum of case counts is always monotonically increasing -- it can only ever go up, or at best, remain flat if there are no new incident cases. This tends to obscure the rate of chnage in incidence over time -- subtle, or even large changes in the slope of the cumulative incidence curve are difficult to see. 

** Semi-log cumulative incidence chart **

The first chart presented here is a semi-log cumulative inncidence chart. This chart seems to have been popularised by [John Burn-Murdoch](https://twitter.com/jburnmurdoch) in the [Financial Times](https://www.ft.com/coronavirus-latest), but it appears it was [first used by Matt Cowgill](https://blog.grattan.edu.au/2020/03/australian-governments-can-choose-to-slow-the-spread-of-coronavirus-but-they-must-act-immediately/) from Australia's very own [Grattan Institute](https://blog.grattan.edu.au). It has since been widely copied and reproduced. Please see a [blog post by Prof Rob Hyndman](https://robjhyndman.com/hyndsight/logratios-covid19/) for further discussion of this chart, and some alternative analyses (one of which we also reproduce in the section on time-varying effective reproduction numbers ($R_{t}$).


### Cumulative Incidence for selected countries

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)

```

```{r gg-cumulative-incidence, fig.height = 8, fig.width = 12}

gg_covid_cumulative_exceed_limit(covid_since_100,
                                 limit = 100) + 
  theme(panel.grid.minor = element_blank())  +
  scale_colour_hue()
```

***

This graphic shows the cumulative cases of COVID-19 for selected countries on a logarithmic scale, with the number of days since each country shown exceeded 100 cumulative cases.

Note that as countries "peel off" the diagonal trajectory, it means their rate of new (incident) cases is reducing. If the line for a country is horizontal, it means there are no new cases occuring there.

The curve for Australia is clearly flattening, and we are keeping good company with China, South Korea and New Zealand as the other countries with nearly horizontal trajectories. Note that after connsiderable initial success in containing COVID-19 spread, both Japan and Singapore are no on a upwards trajectory, bu the slopes of those trajectories are much shallower than the other countries shown.


### Daily Global Incidence

```{r global-cases, fig.height = 8, fig.width = 12}

covid_since_100_w_total <- covid_since_100 %>% 
  group_by(country_region) %>% 
  mutate(total_cases = sum(cases))

covid_since_100_w_total_labels <- slice(covid_since_100_w_total, 1) 

gg_cases <-  ggplot(covid_since_100_w_total,
                    aes(x = date,
                        y = cases,
                        fill = country_region)) + 
  geom_col() + 
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Daily number of COVID19 cases for each country",
       x = "Date since cumulative cases exceeded 100",
       y = "New Cases",
       caption = "CC BY-NC-SA
               Tim Churches (UNSW)
               Nick Tierney (Monash)
               Data source: European CDC") +
  scale_x_datetime(date_labels = "%b %d")

gg_cases + 
    facet_wrap(~reorder(country_region, -total_cases),
               scales = "free") +
  labs(subtitle = "Arranged from highest to smallest cumulative incidence\nwith Y scale freely fit to match data for each country")
  
```

***

The number of cases per day recorded in Australia, as provided by the European CDC.

We note that there are some days where the number of cases appears to spike upwards, followed by a decrease the following day. This indicates that there may be some data discrepancies in how the European CDC is capturing data from WHO Situation Reports. It underlines the importance of nations providing reliable machine-readable access to their own COVID-19 data. By "machine-readable" we mean CSV or JSON data files which are automatically downlaodable, or an API which can be queried automatically to yield such data. Neither of those are difficult to establish, yet nearly all national governments have failed to provide such data, leaving it to third-party agencies abd citizen-science efforts to piece together the required data in a manner that permits ongoing analysis. There is, for example, no official machine-readable source of national COVID-19 data provided by the Australian government. NSW Health is the only State or Territory government that has made any effort in that direction by providing some machine-readable data, which we leverage in the $R_{t}$ _for NSW_ theme (see menu above).  

### Daily Global Incidence (fixed y-axis scale)

```{r world-incidence-free-scales, fig.height = 8, fig.width = 12}
gg_cases + 
    facet_wrap(~reorder(country_region, -total_cases),
               scales = "free_x") +
  labs(subtitle = "Arranged from highest to smallest cumulative incidence\nwith Y scale fixed to assist comparison across countries")
```

***

Forcing the y axis scales to be the same for all plots means that, compared to the previous plot where the y axis could change for each country, the country with the largest number cases, in this case, the USA, appears the same, and the rest of the plots appear smaller.

This give us an important context of the number of cases relative to each country. The bottom row of countries, Australia, Japan, Singapore, and New Zealand barely register.

National-level $R_{t}$ {.storyboard}
=======================================================================

### Explanation

To understand the spread of COVID19, we use a statistic called "R0" (R-nought). This is the number of people we expect to be infected from one COVID19 infected person arriving in a population.

We are estimating R0 from the available data, and are specifically estimating the **effective reproduction number** (different to basic reproduction number). This reflects the current state of a population, which may include some infections. 

**What does R0 mean?**

**If R0 is 1**

- One person arriving to a population could spread it to one other person. Those people could then spread it to one other person. This is easier to manage. 

**If R0 is 0.3**

- For every 10 people infected, it would spread to 3 other people.

**If R0 is 2**

- Every person arriving in the population can infect 2 more people. This can quickly get out of control.

**What do we want R0 to be?**

- We want the R0 to be below 1, and ideally as close to 0 as possible.

**Estimating Effective reproduction number**

We estimate the effective reproduction number using mathematical modelling. This means that the estimated numbers are dependent upon the mathematical model, and while they are our best possible guess at R0, they may be some inaccuracies.

These estimates reflect the number of new cases we expect from an infected person as they interact with a population. The higher the number, the worse the control of the infection, and the more people will be infected. We want this number to be below 1, and preferably as close to 0 as possible.

**Misconceptions / mistakes**

R0 is not a rate, and has no units of time.

This means it is not a rate of infection, and does not tell us how fast an infection spreads.

**Limitations**

These estimates are for all countries do not account for people who bring the infection to the population by travelling. This means that we are assuming all of these infections are spread by the community. However, Australia actually has quite a large proportion of people who are travelling from overseas with COVID19. This means that these estimates might be over-estimating R0. We have explored what is possible if we improve incorporate these imported cases, where we have this data for New South Wales.


### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid_changepoint) %>%
  group_by(country_region) %>% 
  mutate(total_cases = sum(cases)) %>% 
  ungroup() %>% 
  # only look at dates from March
  filter(date > ymd("2020-03-01"))
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}
  gg_effective_repro_all(covid_instant_r) + 
  theme(panel.grid.minor = element_blank())
  # ggthemes::scale_colour_colorblind() +
  # annotation_logticks() 
```

***

The effective R estimates for each country indicate that most countries are bringing the spread of the virus under control. However there is some wide variation. The measurement of effective R for Australia has decreased substantially, now falling below one, indicating that we have now started to control the outbreak.

### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
gg_effective_repro_facet(covid_instant_r)  + 
  facet_wrap(~reorder(country_region, -total_cases)) +
  theme(panel.grid.minor = element_blank())
```

***

This is the same information presented as in the previous graphic, but with each country split into its own graph. This allows us to see the trajectory of effective R. 

Most countries are decreasing, but we notice that Japan and Singapore are fluctuating, due to recent outbreaks.

### Per Country (ribbons)

```{r gg-effective-r-facet-ribbon, fig.height = 8, fig.width = 12}
  gg_effective_repro_facet(covid_instant_r)  + 
  facet_wrap(~reorder(country_region, -total_cases)) +
  geom_ribbon(aes(ymin = quantile_0_025_r,
                  ymax = quantile_0_975_r),
              alpha = 0.1,
              colour = "gray50") 
```

***

This shows the uncertainty around the estimate of the effective R. We notice that as time goes on, there is less uncertainty around the estimate, so we can more confident in our estimate at these later times.

### Australia

```{r this-is-australia}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Australia")
```

***



### Japan

```{r this-is-japan}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Japan")
```

***

Cool!

### South Korea

```{r this-is-south-krea}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "South_Korea")
```

***

Cool!

### China

```{r this-is-china}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "China")
```

***

Cool!

### Germany

```{r this-is-germany}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Germany")
```

***

Cool!

### Spain

```{r this-is-spain}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Spain")
```

***

Cool!

### France

```{r this-is-france}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "France")
```

***

Cool!

### Italy

```{r this-is-italy}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Italy")
```

***

Cool!

### Singapore

```{r this-is-singapore}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Singapore")
```

***

Cool!

### United Kingdom

```{r this-is-uk}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "UK")
```

***

Cool!

### USA

```{r this-is-usa}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "USA")
```

***

Cool!

$R_{t}$ for NSW {.storyboard}
=======================================================================

### Explanation

The total number of incident cases arising at timestep $t$, $I_t$, is the sum of the numbers of incident local ($I_{t}^{local}$) and imported ($I_{t}^{imported}$) cases,

$$ I_t = I_t^{local} + I_t^{imported} $$

It is assumed that, if imported cases exist, they can be distinguished from local cases, for instance through epidemiological investigations, so that 
 $I_{t}^{local}$ and $I_{t}^{imported}$ are observed at each timestep.


$$\Lambda_t(w_s) = \sum_{s=1}^t (I_{t-s}^{local} + I_{t-s}^{imported}) w_s = \sum_{s=1}^t I_{t-s} w_s $$
$$ \mathbb E(I_t^{local} | I_0, I_1, \ldots, I_{t-1}, w_s, T_t) = R_t\Lambda_t (w_s)$$


### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>parametric serial interval distribution

```{r nsw-local-os-sep, fig.width=10, fig.height=10}
A1a / A2a / A3a / A4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary


### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>serial interval distribution estimated from data

```{r nsw-local-os-sep-est-si-dist, fig.width=10, fig.height=10}
A1b / A2b / A3b / A4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- adjusting for potential under-ascertainment, locally-acquired & overseas-acquired cases treated separately**, (cases under investigation excluded), parametric serial interval distribution

```{r nsw-adj-local-acquire-separately, fig.width=10, fig.height=10}
UA1a / UA2a / UA3a / UA4a + plot_layout(heights=c(2,1,1,1))
```

***

In these plots, the counts of incident cases with presumed local sources of infection have been inflated by a factor of 10, and the counts of cases with presumed overseas sources of infection inflated by a factor of 1.5. This mimics ten-fold under-ascertainment of locally-transmitted cases, and 50% under-ascertainment of inbound cases.

---

### **NSW -- adjusting for potential under-ascertainment, locally-acquired & overseas-acquired cases treated separately**, (cases under investigation excluded), serial interval distribution estimated from data

```{r nsw-adj-under-os-separately, fig.width=10, fig.height=10}
UA1b / UA2b / UA3b / UA4b + plot_layout(heights=c(2,1,1,1))
```

***

In these plots, the counts of incident cases with presumed local sources of infection have been inflated by a factor of 10, and the counts of cases with presumed overseas sources of infection inflated by a factor of 1.5. This mimics ten-fold under-ascertainment of locally-transmitted cases, and 50% under-ascertainment of inbound cases.

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>parametric serial interval distribution

```{r nsw-local-os-separately-paramtric, fig.width=10, fig.height=10}
B1a / B2a / B3a / B4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>serial interval distribution estimated from data

```{r nsw-local-os-sep-si-dist-data, fig.width=10, fig.height=10}
B1b / B2b / B3b / B4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---


### **NSW -- all cases treated as locally-acquired**<br>parametric serial interval distribution

```{r nsw-all-cases-locally, fig.width=10, fig.height=10,}
C1a / C2a / C3a + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---

### **NSW -- all cases treated as locally-acquired**<br>serial interval distribution estimated from data

```{r nsw-all-cases-locally-si-est-data, fig.width=10, fig.height=10,}
C1b / C2b / C3b + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---




