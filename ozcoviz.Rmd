---
title: "OzCoViz"
date: "`r paste('last updated', format(lubridate::now(), '%H:%M, %d %B %Y'))`"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    social: ["menu"]
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(lubridate)
library(EpiEstim)
library(patchwork)
library(gganimate)
# devtools::install_github('emitanaka/datalegreyar')
library(datalegreyar)
library(memoise)

knitr::opts_chunk$set(cache = FALSE)
```

```{r center-covid-from-100}
selected_countries <- c(
                        "Australia",
                        "China",
                        "Italy",
                        "Singapore",
                        "United_Kingdom",
                        "United_States_of_America",
                        "South_Korea",
                        "New_Zealand",
                        # "Canada",
                        "Germany", 
                        "Japan",
                        # "Iran",
                        "Spain",
                        "France")
                        # "Denmark"
```


```{r pull-data}
yesterday <- today() - 1L

covid <- covid_latest() %>% 
#   filter(date < yesterday) %>% 
  filter(country_region %in% selected_countries) %>% 
  mutate(country_region = case_when(
    country_region == "United_States_of_America" ~ "USA",
    country_region == "United_Kingdom" ~ "UK",
    TRUE ~ country_region
    )
    )

```


```{r covid-changepoint}
covid_changepoint <- covid %>% 
  add_covid_change_point() %>% 
  filter(date >= change_point_date)
```

```{r load-nsw-funcs, cache=FALSE, include = FALSE}
source("get_nsw_data.R")
source("get_nishiura_si_sample.R")
source("plot_nsw_eff_r.R")
```

```{r prep-nsw-data-and-plots, cache=FALSE, include = FALSE}
source("nsw_eff_R_data_and_plot_prep.R")
```

Overview
=======================================================================

```{r datalegreyar, fig.align='center'}
# this just takes the last 21 days of Australian data, Ideally it should show the 
# whole history of Australian data since, say 1st March 2020

vals <- covid %>%
          filter(country_region == "Australia") %>%
          arrange(date) %>%
          top_n(26, wt = row_number()) %>%
          pull(cases)

maxpos <- which(vals == max(vals))
if (all(vals[maxpos] > vals[18:26])) {
  fig(datafy(values = vals, 
             text = "oz covid 19 visualisations", 
             ignore_space = TRUE), 
      size=60,
      symbol = setNames(c(maxpos, 18:25), 
                        c("max", rep("down",8))))
} else {
  fig(datafy(values = vals, 
             text = "oz covid 19 visualisations", 
             ignore_space = TRUE), 
      size = 60,
      symbol = setNames(c(maxpos, 18:54), 
                        c("max", rep("up",8))))
}
    
```

The time-series line in the heading above is derived from current incidence cases of COVID-19 in Australia.

Column  {.tabset}
-----------------------------------------------------------------------

### Introduction

This web site is a joint effort of researchers at the [South Western Sydney Clinical School](https://swscs.med.unsw.edu.au) and the [Centre for Big Data Research in Health](https://cbdrh.med.unsw.edu.au) at the [UNSW Faculty of Medicine](https://med.unsw.edu.au), the [Econometrics and Business Statistics Research Group](https://research.monash.edu/en/organisations/econometrics-business-statistics) of [Monash University](https://www.monash.edu/), and at the [Ingham Institute for Applied Medical Research](https://inghaminstitute.org.au) in Liverpool, Sydney. 

```{r, out.width="20%", fig.show='hold', out.extra='style="padding:25px"'}
knitr::include_graphics(path=here::here("assets/cbdrh_logo.png"))
knitr::include_graphics(path=here::here("assets/unsw_logo.png"))
knitr::include_graphics(path=here::here("assets/monash-logo-mono.png"))
knitr::include_graphics(path=here::here("assets/ingham_logo.png"))
```

```{r, out.width="20%", fig.align="right", eval=FALSE}
knitr::include_graphics(path=here::here("assets/cbdrh_logo.png"))
```

The intent is to offer a range of principled epidemiological and statistical analyses and visualisations of current COVID-19 data which go beyond the now ubiquitous [world maps and cumulative incidence charts](https://coronavirus.jhu.edu/map.html). 

The broad themes for the analyses and visualisations currently available are listed in the menu at the top of this page -- more will be added in due course. For each theme there is an introductory page explaining the motivating ideas and methodology employed for each of the visualisations or analyses for that theme, which are available in the subsequent frames (the series of rectangles at the top of each page). Additional notes or commentary appear on the right of some pages.

#### An Australian focus with an international perspective

This site has been created by researchers at Australian universities, and hence the focus is on the situation in Australia, within the broader international context -- we are, after all, all in this together. However, we hope that some of the analyses and visualisations on this site might be useful elsewhere, and to that end, all the [`R`](https://www.r-project.org) source code used to create this site if freely available -- please see the _Technical details_ tab above for details on software used, and where to find the source code. 

### Contributors

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />The content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. If you wish to re-use any of the content, please retain the attribution which appears on each chart or set of charts, or otherwise provide that attribution alongside the content that you re-use.

In turn, we acknowledge [RECON](https://www.repidemicsconsortium.org/) for providing financial support, and [European Centre for Disease Control](https://www.ecdc.europa.eu/en) who have provided [up to date data](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide) on the COVID19 pandemic.

Project has been led by [Timothy Churches](https://timchurches.github.io/blog/about.html), [Nicholas Tierney](https://www.njtierney.com/), with thanks to [Stuart Lee](https://stuartlee.org/), [Dianne Cook](http://dicook.org/), [Miles McBain](https://github.com/MilesMcBain), and [Rob Hyndman](https://robjhyndman.com/)

Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

Source code for this visualisation are available at [covid-flexdashboard](https://github.com/CBDRH/covid-flexdashboard)

### Technical Details

Data Analysis has been entirely created within the [R programming language](https://cran.r-project.org/) using [Rstudio](https://rstudio.com/).

Packages used include:

- [flexdashboard](https://cran.r-project.org/web/packages/flexdashboard)
- [tidyverse](https://cran.r-project.org/web/packages/tidyverse)
- [magrittr](https://cran.r-project.org/web/packages/magrittr)
- [countrycode](https://cran.r-project.org/web/packages/countrycode)
- [janitor](https://cran.r-project.org/web/packages/janitor)
- [scales](https://cran.r-project.org/web/packages/scales)
- [readxl](https://cran.r-project.org/web/packages/readxl)
- [httr](https://cran.r-project.org/web/packages/httr)
- [glue](https://cran.r-project.org/web/packages/glue)
- [EpiEstim](https://cran.r-project.org/web/packages/EpiEstim)
- [changepoint](https://cran.r-project.org/web/packages/changepoint)
- [ggrepel](https://cran.r-project.org/web/packages/ggrepel)
- [memoise](https://cran.r-project.org/web/packages/memoise)
- [patchwork](https://cran.r-project.org/web/packages/patchwork)
- [datalegreyar](https://github.com/emitanaka/datalegreyar)
- [memoise](https://cran.r-project.org/web/packages/)


Incidence {.storyboard}
=======================================================================

### Explanation

Incidence is the epidemiological term for the number of cases of a disease meeting some case definition in a specified time period. Here we present the daily incidence -- that is, the number of new cases each day -- of COVID-19 for a range of countries, including Australia, of course. Each country may be using a slightly different case definition, although most of the countries presented here have been using case definitions aligned with those [recommended by the WHO](https://www.who.int/publications-detail/global-surveillance-for-human-infection-with-novel-coronavirus-(2019-ncov)). Three types of case definition are used, simultaneously:

* **Suspected cases**
* **Probable cases**
* **Confirmed (by laboratory test) cases**

All of the data reported here are for **confirmed cases**, with a few exceptions (China included cases diagnosed via lung CT scan for a few days in Februrary, 20020, but we have adjusted the data for those days as far as possible to remove that anomaly.

The data are drawn from the [European CDC](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide), which has collected data from various governing agencies around the world. There are some small discrepancies between these data and those given by the Australian government, and indeed other national governemnst, due to timing issues relating to when cases are tabulated each day, and so on. However, we ebelive the the European CDC to be teh best source of automatically downloadable, machine-readable data there is right now.

Note, however, that because the **confirmed** case definition depends on laboratory confirmation, it is influenced by the number of lab tests (RT-PCR, reverse transcriptase polymerase chain reaction tests on nasopharyngeal swabs or sputum) done by each reporting country or jurisdiction. Obviously the number of reported cases is bounded by the number of such labs tests which are done, but the degree of under-ascertainment is also affected by the policies in place which determine which potential COVID-19 cases are tested. These policies are completely country-specific and have changed over time.

Another issue with these data is that it is vastly preferrable to analyse incidence by (presumed or definite) date of onset of symptoms, rather than by date of notification or date of reporting. Theer may be variable delays in the processing of laboratory tests and the reporting of cases to central authorities. Tabulation of incidence counts by date of onset overcomes this problem. Almost all national and jurisdictional health authorities will be collecting data on presumed date of onset for each case (although, inexplicably, it is **not** one of the data items on the [WHO-recommended data collection form](https://apps.who.int/iris/bitstream/handle/10665/331234/WHO-2019-nCoV-SurveillanceCRF-2020.2-eng.pdf)). One reason for not using date of onset is that it may be incomplete, but this ignores the fact that statistical imputation can be used to validly fill in those missing dates of onset. There are also a body of methods, collectively known as _nowcasting_, that use multivariate time-series models to convert data tabulated by date of notification/reporting to (estimated) date of onset. If national or jurisdictional health authorities do not have the technical capacity to undertake such value-adding to their own data, they should make the required data available to trusted partners in the academic sector who can undertake such statistical manipulation for them (or help authorities implement such processing internally).

#### Cumulative Incidence

Cumulative incidence is, as the name suggests, just the cumulative sum of the daily incidence - that is, a running total of the number of cases. Reporting of cumulative COVID-19 seems to dominate the mainstream media, but it has many disadvantages. In particular, a cumulative sum of case counts is always monotonically increasing -- it can only ever go up, or at best, remain flat if there are no new incident cases. This tends to obscure the rate of chnage in incidence over time -- subtle, or even large changes in the slope of the cumulative incidence curve are difficult to see. 

#### Semi-log cumulative incidence chart

The first chart presented here is a semi-log cumulative inncidence chart. This chart seems to have been popularised by [John Burn-Murdoch](https://twitter.com/jburnmurdoch) in the [Financial Times](https://www.ft.com/coronavirus-latest), but it appears it was [first used by Matt Cowgill](https://blog.grattan.edu.au/2020/03/australian-governments-can-choose-to-slow-the-spread-of-coronavirus-but-they-must-act-immediately/) from Australia's very own [Grattan Institute](https://blog.grattan.edu.au). It has since been widely copied and reproduced. Please see a [blog post by Prof Rob Hyndman](https://robjhyndman.com/hyndsight/logratios-covid19/) for further discussion of this chart, and some alternative analyses (one of which we also reproduce in the section on time-varying effective reproduction numbers ($R_{t}$).

There are several variations on the _Grattan+ chart presented, please see the notes for each one.

#### _Epicurves_

The _epicurve_ is perhaps the most-used chart in field epidemiology and outbreak control. It is simply a chart of daily (or weekly, for slower-moving diseases) incidence (new cases), traditionally shown as a bar chart. It gives an immediate sense of whether an outbreak or epidemic is in a growth phase, with increasing incident counts each successive day, or in a decay phase, with decreasing counts each successive day. Note that the cumulative count will still increase, day-on-day, even when an outbreak or epidemic is in a decay phase. Only when the epidemic has been completely extinguished will the cumulative incidence stop increasing. That's one of the reasons why cumulative incidence charts are rarely used by epidemiologists.

Three variations of _epicurves_ are provided here: 

* the usual _epicurve_, on a linear y-axis, and with the ranges specific for each country to maximise the amount of detail discernable
* the same chart, but with a logarithmic y-axis, which allows the periods with lower counts to be inspected in greater detail;
* the usual _epicurve_, on a linear y-axis, but with the same y-axis scale across all countries, which clearly shows the relative incidence in each country. This chart is quite startling.

### Semi-log **cumulative incidence** for selected countries -- the _Grattan Institute_ chart

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)

```

```{r gg-cumulative-incidence, fig.height = 8, fig.width = 12}

gg_covid_cumulative_exceed_limit(covid_since_100,
                                 limit = 100) + 
  theme(panel.grid.minor = element_blank())  +
  scale_colour_hue()
```

***

This chart shows the cumulative cases of COVID-19 for selected countries on a logarithmic y-axis scale, with the dates on the x-axis converted to the number of days since each country shown exceeded 100 cumulative cases, on a linear x-axis scale (hence the name _semi-log_, since only one of the two axes is logarithmic).

Note that countries "peel off" the diagonal trajectory as their rate of new (incident) cases reduces. If the line for a country is horizontal, it means there are no new cases occurring there.

The curve for Australia is clearly flattening, and we are keeping good company with China, South Korea and New Zealand as the other countries with nearly horizontal trajectories. Note that after considerable initial success in containing COVID-19 spread, both Japan and Singapore are now on a upwards trajectory, but the slopes of those trajectories are much shallower than the other countries shown, indicating much slower spread in those countries.

### Semi-log **cumulative incidence** for selected countries -- aligned to start of epidemic in each country

```{r since-cp}
covid_since_changepoint <- covid %>% 
  add_covid_change_point() %>%
  rename(days_since_limit = days_since_changepoint) %>% 
  filter(days_since_limit >= 0)
```

```{r gg-cumulative-incidence-since-cp, fig.height = 8, fig.width = 12}
gg_covid_cumulative_exceed_limit(covid_since_changepoint,
                                 limit = NULL) + 
  theme(panel.grid.minor = element_blank())  +
  scale_colour_hue()
```

***

This chart is a variation on the previous _Grattan Institute_ chart. It isn't really an improvement on the _Grattan_ chart, but is shown here to illustrate the sensitivity of the _Grattan_ chart to the method used to align the dates on the x-axis. In the chart shown at left, the dates on the x-axis are aligned to the approximate start of the COVID-19 epidemic in each country. The start dates are chosen automatically using a non-parametric changepoint detection algorithm, (see the [`changepoint.np` package](https://CRAN.R-project.org/package=changepoint.np ) for `R`). The changepoints for each country shown are as follows:

```{r cp-table}
covid_since_changepoint %>%
  distinct(country_region, change_point_date) %>%
  arrange(change_point_date) %>%
  mutate(country_region = stringr::str_replace_all(country_region,
                                                    pattern = "_",
                                                    replacement = " ")) %>%
  knitr::kable(col.names=c("Country", "Detected start of epidemic"))
```

### Semi-log daily **incidence** for selected countries -- aligned to start of epidemic in each country

```{r gg-incidence-since-cp, fig.height = 8, fig.width = 12}
gg_covid_incidence_exceed_limit(covid_since_changepoint,
                                 limit = NULL) + 
  theme(panel.grid.minor = element_blank())  +
  scale_colour_hue() +
  scale_y_log10(labels = scales::comma_format(accuracy=1))
  
```

***

This is another variation on the _Grattan Institute_ chart, but this time showing daily incidence on the y-axis, rather than daily **cumulative** incidence. It is basically the same information as shown in the _epicurve_ charts in the subsequent frames (accessed via the blue rectangles at the top of the page), but all of the selected countries are shown on one plot, and the dates are aligned by the detected start of the epidemic in each country.

One problem is that the daily incidence curves are rather noisy. We can address that by smoothing them, as shown in the next frame.

### Semi-log **smoothed** daily **incidence** for selected countries -- aligned to start of epidemic in each country

```{r gg-incidence-since-cp-smoothed, fig.height = 8, fig.width = 12}
gg_covid_incidence_exceed_limit(covid_since_changepoint,
                                 limit = NULL,
                                 smooth=TRUE,
                                 span=0.2) + 
  theme(panel.grid.minor = element_blank())  +
  scale_colour_hue() +
  scale_y_log10(labels = scales::comma_format(accuracy=1))

```

***
In this chart, we can now discern three distinct groups of countries:

* an upper group of just one, the USA, where the epidemic is still growing rapidly.
* a middle group comprising the UK and European countries
* a lower group, which includes Australia , New Zealand, South Korea, China, Japan and Singapore, which all have their local COVID-19 epidemics under control (but definitely not eradicated). Note however that Japan and Singapore are now exiting that lower group and heading upwards.


### _Epicurves_ for selected countries

```{r global-cases, fig.height = 8, fig.width = 12}

covid_since_changepoint_w_total <- covid_changepoint %>% # was:  covid_since_100
  group_by(country_region) %>% 
  mutate(total_cases = sum(cases))

covid_since_changepoint_w_total_labels <- slice(covid_since_changepoint_w_total, 1) 

gg_cases <-  ggplot(covid_since_changepoint_w_total,
                    aes(x = date,
                        y = cases,
                        fill = country_region)) + 
  geom_col() + 
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "COVID-19 epicurves for confirmed incident cases for selected countries",
       subtitle = glue::glue("Up to  {format(max(covid_changepoint$date), '%d %b %Y')}"),
       x = "Date",
       y = "Incident cases",
       caption = glue::glue("Tim Churches (UNSW) & Nick Tierney (Monash)
                  Data source: European CDC up to {format(max(covid_since_changepoint_w_total$date),'%d %b %Y')}")) +
  scale_x_datetime(date_labels = "%d %b")

gg_cases + 
    facet_wrap(~reorder(country_region, -total_cases),
               scales = "free") +
  labs(subtitle = "Arranged from highest to smallest cumulative incidence.\nNote: both x-axis and y-axis scales are different for each country")
  
```

***

The charts shown here are _epicurves_ -- that is, daily count of incident (new) cases, using data collated by the European CDC.

Note that there are some days where the number of cases appears to spike upwards, followed by a decrease the following day. This indicates that there may be some data discrepancies in how the European CDC is capturing data from WHO Situation Reports. It underlines the importance of nations providing reliable machine-readable access to their own COVID-19 data. By "machine-readable" we mean CSV or JSON data files which are automatically downlaodable, or an API which can be queried automatically to yield such data. Neither of those are difficult to establish, yet nearly all national governments have failed to provide such data, leaving it to third-party agencies and citizen-science efforts to piece together the required data in a manner that permits ongoing analysis. There is, for example, no official machine-readable source of national COVID-19 data provided by the Australian government. As far as we are aware, NSW is the only State or Territory government that has made any effort in that direction by providing some machine-readable data, which we leverage in the $R_{t}$ _for NSW_ theme (see menu above).  

### _Epicurves_ for selected countries (common y-axis scale)

```{r world-incidence-free-scales, fig.height = 8, fig.width = 12}
gg_cases + 
    facet_wrap(~reorder(country_region, -total_cases),
               scales = "free_x") +
  labs(subtitle = "Arranged from highest to smallest cumulative incidence\nwith y-axis scale fixed to facilitate comparisons between countries")
```

***

Forcing the y-axis scale to be the same for all the plots in this chart means that, compared to the previous chart where the y-axis could change for each country, the country with the largest number cases, in this case, the USA, appears the same, and the rest of the plots appear smaller.

This provides important context: the number of cases in the USA currently dominates relative to other countries. The bottom row of countries are barely visible, by comparison.

### _Epicurves_ for selected countries (logarithmic y-axis scale)

```{r world-incidence-free-scales-log, fig.height = 8, fig.width = 12}
gg_cases + 
    facet_wrap(~reorder(country_region, -total_cases), 
               scales="free") +
    scale_y_log10() +
  labs(subtitle = "Arranged from highest to smallest cumulative incidence\nwith logarithmic y-axis scales, different for each country")
```

***

The final variation the _epicurve_ chart, show here, uses a logarithmic y-axis scale. This emphasises lower counts, which is useful for inspecting the beginnings and ends of the epicurves, or the middle parts where there is more than one "wave", as in China and Singapore.

National-level $R_{t}$ {.storyboard}
=======================================================================

### Explanation

A key statistic in field epidemiology is the _basic reproduction number_, often referred to as "R-zero" or "R-nought", and written $R_{0}$. This is the number of people we expect each new case of a disease such as COVID-10 to infect -- in other words, how many people each case passes the disease on to -- at the **beginning** of a disease outbreak or epidemic, **before** any public health controls or interventions have been established or put in place. 

$R_{0}$ was popularised in the 2011 film _Contagion_. Here is Gwyneth Paltrow, who plays a US CDC epidemiologist, explaining $R_{0}$ (with a few errors -- it's _reproduction number_, not "reproductive rate" as she say) to government officials: 

<iframe width="560" height="315" align="center" src="https://www.youtube.com/embed/VrATMF_FB9M" frameborder="0" allowfullscreen></iframe>
<br>

As explained in the film clip above, $R_{0}$ is determined by a number of factors, but is a very useful metric of how fast a communicable disease will spread in a population, if **nothing is done** to stop or slow it. Note that $R_{0}$ is **not** solely a characteristic of a pathogen (such as a virus) _per se_, but rather depends on the nature and biological behaviour of the pathogen, but also how it is transmitted, who often members of teh population engage in behaviours that may transmit it, population density, whetheher any members of teh population are immune or resistant to the disease, and so on. In other words, $R_{0}$ is highly situation-specific.

As such, $R_{0}$ is useful in the early stages of an epidemic, but as soon as (effective) public health interventions have been put in place to slow the spread of the disease, the reproduction number will change. This metric is referred to as the _effective reproduction number_, denoted $R_{t}$, where $t$ stands for time. In other words, $R_{t}$ is the reproduction number at a particular point in time, $t$.

#### What are the implications of the _effective reproduction number_?

** If $R_{t}$ equals 1.0**

- Each infected person spreads the disease, on average, to one other person during the course of their illness (which ends when they either recover or die). Therefore, in the long-run, the number of infected people neither grows nor shrinks. Fron day-to-day there may be some variation, but overall the number of new infections stays the same. 

**If $R_{t}$ is greater than 1.0**

- Each infected person spreads the disease, on average, to more than one other person during the course of their illness. Each of those spread the disease to more than one additional people, and so on. It is easy to see that this results in a growing number of new infections each day, and that growth rate itself also grows -- the so-called exponential growth of an epidemic (at least in its early stages). If $R_{0}$ initially, or $R_{t}$, later, is only just greater than 1.0, then the disease spreads only slowly,but is the _reproduction number_ is well above 1.0, say, 2.0 or more, then rapid spread results. 

**If $R_{t}$ is less than 1.0**

- Each infected person spreads the disease, on average, to fewer than one other person during the course of their illness (obviously each person spreads it to a whole number of other people eg zero, one, two, three, but _on average_, taken across a large number of infected individuals, the number infected by each person with the disease is less than one. Again, it is easy to see that this results in a falling number of new infections each day, and that rate of decay in the number of new infections also decays -- in other words, epidemics decay exponentially too. As an aisde, just a epidemics tend to grow much more quickly than most people expect -- humans tend to reason using linear heuristics -- so do epidemics decay much more **slowly** that people expect, for the same reason -- humans assume linear behaviour, which does not (necessarily) apply to communicable disease dynamics.  


#### Estimating the time-varying _effective reproduction number_ $R_{t}$

We estimate the _effective reproduction number_ $R_{t}$ using a statistical model which was developed in 2013 by Anne Cori and colleagues at Imperial College London (ICL), as described in [ref]. The method was later extended by Thompson and colleagues (including Anne Cori), also at ICL, as described in [ref]. We won't go into the details of the model here -- they are described in details in the cited papers -- but we will remark on a few key points that need to be born in mind when interpreting these statistics. 

The first is that the methods we use here estimate the **instantaneous** effective reporoduction number, which is...

The second point to bear in mind is that the _reproduction number_ is an estimate of the spread of an infection is a specific, local population, and thus we should only use counts of incident (new) infections which result from local spread when estimating it, and (UP TO HERE) 

These estimates reflect the number of new cases we expect from an infected person as they interact with a population. The higher the number, the worse the control of the infection, and the more people will be infected. We want this number to be below 1, and preferably as close to 0 as possible.

**Limitations**

These estimates are for all countries do not account for people who bring the infection to the population by travelling. This means that we are assuming all of these infections are spread by the community. However, Australia actually has quite a large proportion of people who are travelling from overseas with COVID19. This means that these estimates might be over-estimating R0. We have explored what is possible if we improve incorporate these imported cases, where we have this data for New South Wales.


### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid_changepoint) %>%
  group_by(country_region) %>% 
  mutate(total_cases = sum(cases)) %>% 
  ungroup() %>% 
  # only look at dates from March
  filter(date > ymd("2020-03-01"))
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}
  gg_effective_repro_all(covid_instant_r) + 
  theme(panel.grid.minor = element_blank())
  # ggthemes::scale_colour_colorblind() +
  # annotation_logticks() 
```

***

The effective R estimates for each country indicate that most countries are bringing the spread of the virus under control. However there is some wide variation. The measurement of effective R for Australia has decreased substantially, now falling below one, indicating that we have now started to control the outbreak.

### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
gg_effective_repro_facet(covid_instant_r)  + 
  facet_wrap(~reorder(country_region, -total_cases)) +
  theme(panel.grid.minor = element_blank())
```

***

This is the same information presented as in the previous graphic, but with each country split into its own graph. This allows us to see the trajectory of effective R. 

Most countries are decreasing, but we notice that Japan and Singapore are fluctuating, due to recent outbreaks.

### Per Country (ribbons)

```{r gg-effective-r-facet-ribbon, fig.height = 8, fig.width = 12}
  gg_effective_repro_facet(covid_instant_r)  + 
  facet_wrap(~reorder(country_region, -total_cases)) +
  geom_ribbon(aes(ymin = quantile_0_025_r,
                  ymax = quantile_0_975_r),
              alpha = 0.1,
              colour = "gray50") 
```

***

This shows the uncertainty around the estimate of the effective R. We notice that as time goes on, there is less uncertainty around the estimate, so we can more confident in our estimate at these later times.

### Australia

```{r this-is-australia}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Australia")
```

***



### Japan

```{r this-is-japan}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Japan")
```

***

Cool!

### South Korea

```{r this-is-south-krea}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "South_Korea")
```

***

Cool!

### China

```{r this-is-china}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "China")
```

***

Cool!

### Germany

```{r this-is-germany}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Germany")
```

***

Cool!

### Spain

```{r this-is-spain}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Spain")
```

***

Cool!

### France

```{r this-is-france}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "France")
```

***

Cool!

### Italy

```{r this-is-italy}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Italy")
```

***

Cool!

### Singapore

```{r this-is-singapore}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "Singapore")
```

***

Cool!

### United Kingdom

```{r this-is-uk}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "UK")
```

***

Cool!

### USA

```{r this-is-usa}
gg_effective_repro_incidence_patchwork(covid_instant_r,
                                       covid,
                                       "USA")
```

***

Cool!

$R_{t}$ for NSW {.storyboard}
=======================================================================

### Explanation

The total number of incident cases arising at timestep $t$, $I_t$, is the sum of the numbers of incident local ($I_{t}^{local}$) and imported ($I_{t}^{imported}$) cases,

$$ I_t = I_t^{local} + I_t^{imported} $$

It is assumed that, if imported cases exist, they can be distinguished from local cases, for instance through epidemiological investigations, so that 
 $I_{t}^{local}$ and $I_{t}^{imported}$ are observed at each timestep.


$$\Lambda_t(w_s) = \sum_{s=1}^t (I_{t-s}^{local} + I_{t-s}^{imported}) w_s = \sum_{s=1}^t I_{t-s} w_s $$
$$ \mathbb E(I_t^{local} | I_0, I_1, \ldots, I_{t-1}, w_s, T_t) = R_t\Lambda_t (w_s)$$


### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>parametric serial interval distribution

```{r nsw-local-os-sep, fig.width=10, fig.height=10}
A1a / A2a / A3a / A4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary


### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>serial interval distribution estimated from data

```{r nsw-local-os-sep-est-si-dist, fig.width=10, fig.height=10}
A1b / A2b / A3b / A4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- adjusting for potential under-ascertainment, locally-acquired & overseas-acquired cases treated separately**, (cases under investigation excluded), parametric serial interval distribution

```{r nsw-adj-local-acquire-separately, fig.width=10, fig.height=10}
UA1a / UA2a / UA3a / UA4a + plot_layout(heights=c(2,1,1,1))
```

***

In these plots, the counts of incident cases with presumed local sources of infection have been inflated by a factor of 10, and the counts of cases with presumed overseas sources of infection inflated by a factor of 1.5. This mimics ten-fold under-ascertainment of locally-transmitted cases, and 50% under-ascertainment of inbound cases.

---

### **NSW -- adjusting for potential under-ascertainment, locally-acquired & overseas-acquired cases treated separately**, (cases under investigation excluded), serial interval distribution estimated from data

```{r nsw-adj-under-os-separately, fig.width=10, fig.height=10}
UA1b / UA2b / UA3b / UA4b + plot_layout(heights=c(2,1,1,1))
```

***

In these plots, the counts of incident cases with presumed local sources of infection have been inflated by a factor of 10, and the counts of cases with presumed overseas sources of infection inflated by a factor of 1.5. This mimics ten-fold under-ascertainment of locally-transmitted cases, and 50% under-ascertainment of inbound cases.

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>parametric serial interval distribution

```{r nsw-local-os-separately-paramtric, fig.width=10, fig.height=10}
B1a / B2a / B3a / B4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>serial interval distribution estimated from data

```{r nsw-local-os-sep-si-dist-data, fig.width=10, fig.height=10}
B1b / B2b / B3b / B4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---


### **NSW -- all cases treated as locally-acquired**<br>parametric serial interval distribution

```{r nsw-all-cases-locally, fig.width=10, fig.height=10,}
C1a / C2a / C3a + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---

### **NSW -- all cases treated as locally-acquired**<br>serial interval distribution estimated from data

```{r nsw-all-cases-locally-si-est-data, fig.width=10, fig.height=10,}
C1b / C2b / C3b + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---




