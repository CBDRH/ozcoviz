---
title: "OzCoViz"
date: "`r lubridate::now()`"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    social: ["menu"]
---

```{r setup, include=FALSE}
library(flexdashboard)
library(covidrecon)
library(tidyverse)
library(lubridate)
library(EpiEstim)
library(patchwork)
library(gganimate)
# devtools::install_github('emitanaka/datalegreyar')
library(datalegreyar)
library(memoise)

knitr::opts_chunk$set(cache = FALSE)
```

```{r center-covid-from-100}
selected_countries <- c(
                        "Australia",
                        "China",
                        "Italy",
                        "Singapore",
                        "United_Kingdom",
                        "United_States_of_America",
                        "South_Korea",
                        # "Canada",
                        "Germany", 
                        "Japan",
                        # "Iran",
                        "Spain",
                        "France")
                        # "Denmark"
```


```{r pull-data}
yesterday <- today() - 1L

covid <- covid_latest() %>% 
  filter(date < yesterday) %>% 
  filter(country_region %in% selected_countries) %>% 
  mutate(country_region = case_when(
    country_region == "United_States_of_America" ~ "USA",
    country_region == "United_Kingdom" ~ "UK",
    TRUE ~ country_region
    )
    )

```


```{r covid-changepoint}
## not needed anymore since we'll fit it to the whole dataset and filter later
# covid_changepoint <- covid %>% 
#   add_covid_change_point() %>% 
#   filter(date >= change_point_date)
```

```{r load-nsw-funcs, cache=FALSE, include = FALSE}
source("get_nsw_data.R")
source("get_nishiura_si_sample.R")
source("plot_nsw_eff_r.R")
```

```{r prep-nsw-data-and-plots, cache=FALSE, include = FALSE}
source("nsw_eff_R_data_and_plot_prep.R")
```

Overview
=======================================================================

```{r datalegreyar}
# this just takes the last 21 days of Australian data, Ideally it should show the 
# whole history of Australian data since, say 1st March 2020

vals <- covid %>%
          filter(country_region == "Australia") %>%
          arrange(date) %>%
          top_n(25, wt = row_number()) %>%
          pull(cases)

maxpos <- which(vals == max(vals))
if (all(vals[maxpos] > vals[18:25])) {
  fig(datafy(values = vals, 
             text = "oz covid19 visualisations", 
             ignore_space = FALSE), 
      size=60,
      symbol = setNames(c(maxpos, 18:24), 
                        c("max", rep("down",7))))
} else {
  fig(datafy(values = vals, 
             text = "oz covid19 visualisations", 
             ignore_space = FALSE), 
      size = 60,
      symbol = setNames(c(maxpos, 18:24), 
                        c("max", rep("up",7))))
}
    
```

The time-series line in the heading above is derived from current incidence cases of COVID-19 in Australia.

Column  {.tabset}
-----------------------------------------------------------------------

### Overview

This dashboard presents two key pieces of data analysis:

1. Case Incidence
2. Effective reproduction number

**Case Incidence**

This presents the daily number of cumulative cases, and daily cases of COVID19 for selected countries around the world. The data is drawn from the [European CDC](), which has collected data from various governing agencies around the world. There are some small discrepancies between this data and that given by the official Australian government results, but in the absence of up to date easily obtainable data from Australia, this is the highest quality data that we have.

**Effective reproduction number**

These estimates reflect the number of new cases we expect from an infected person as they interact with a population. The higher the number, the worse the control of the infection, and the more people will be infected. We want this number to be below 1, and preferably as close to 0 as possible.


### Contributors

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

Users must provide personal and institutional acknowledgement on reuse

In turn, we acknowledge RECON, and EuroCDC

Project has been led by [Timothy Churches](), [Nicholas Tierney](), with thanks to [Stuart Lee](), [Dianne Cook](), and [Miles McBain]()

Visualisations and analysis made available in the [`covidrecon` package](https://github.com/CBDRH/covidrecon)

Source code for this visualisation are available at [covid-flexdashboard](https://github.com/CBDRH/covid-flexdashboard)

### Technical Details

Data Analysis has been entirely created within the [R programming language](), and [Rstudio]()

The dashboard can be entirely recreated using the open source code provided at [github]()

Packages used include:

- [flexdashboard](https://cran.r-project.org/web/packages/flexdashboard)
- [tidyverse](https://cran.r-project.org/web/packages/tidyverse)
- [magrittr](https://cran.r-project.org/web/packages/magrittr)
- [countrycode](https://cran.r-project.org/web/packages/countrycode)
- [janitor](https://cran.r-project.org/web/packages/janitor)
- [scales](https://cran.r-project.org/web/packages/scales)
- [readxl](https://cran.r-project.org/web/packages/readxl)
- [httr](https://cran.r-project.org/web/packages/httr)
- [glue](https://cran.r-project.org/web/packages/glue)
- [EpiEstim](https://cran.r-project.org/web/packages/EpiEstim)
- [changepoint](https://cran.r-project.org/web/packages/changepoint)
- [ggrepel](https://cran.r-project.org/web/packages/ggrepel)
- [memoise](https://cran.r-project.org/web/packages/memoise)
- [patchwork](https://cran.r-project.org/web/packages/patchwork)
- [datalegreyar](https://github.com/emitanaka/datalegreyar)
- [memoise](https://cran.r-project.org/web/packages/)



Incidence {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Explanation

**Case Incidence**

This presents the daily number of cumulative cases, and daily cases of COVID19 for selected countries around the world. The data is drawn from the [European CDC](), which has collected data from various governing agencies around the world. There are some small discrepancies between this data and that given by the official Australian government results, but in the absence of up to date easily obtainable data from Australia, this is the highest quality data that we have.

### Cumulative Incidence for selected countries

```{r since-100}
covid_since_100 <- covid %>% 
  add_days_since_limit(limit = 100) %>% 
  filter(days_since_limit >= 0)

```

```{r gg-cumulative-incidence}

gg_covid_cumulative_exceed_limit(covid_since_100,
                                 limit = 100) + 
  theme(panel.grid.minor = element_blank()) 
  # ggthemes::scale_colour_colorblind() +
  # annotation_logticks(sides = "l") 
```


### Australian incidence

```{r oz-cases}
library(glue)
covid_since_100_au <- covid_since_100 %>% 
  filter(geo_id == "AU") 
  
oz_cases_max_date <- format(max(covid_since_100_au$date), "%d %B %Y")
oz_cases_min_date <- format(min(covid_since_100_au$date), "%d %B %Y")

gg_cases <- ggplot(covid_since_100_au,
       aes(x = date,
           y = cases)) + 
  geom_col(fill = "black") + 
  theme_minimal() +
  labs(title = "COVID-19 epidemic case incidence",
       subtitle = glue(
         "For Australia from {oz_cases_min_date} to {oz_cases_max_date}"
       ),
       x = "Date since cumulative cases exceeded 100",
       y = "New Cases",
       caption = "CC BY-NC-SA
               Tim Churches (UNSW)
               Nick Tierney (Monash)
               Data source: European CDC")

gg_cases
  
```

### Australian incidence (semi-log)

```{r oz-cases-log10}
gg_cases +
   scale_y_log10() +
  theme(panel.grid.minor = element_blank()) +
  # annotation_logticks() + 
  labs(y = "New Cases (Log Scale")
  
```


National-level $R_{t}$ {.tabset}
=======================================================================

Column  {.tabset}
-----------------------------------------------------------------------

### Explanation

To understand the spread of COVID19, we can look at a statistic called "R0" (R-nought). This is the number of people we expect to be infected if one COVID19 infected person arrives, and can spread it.

The R0 is the number of people we expect are directly caused by the spread of this one person. 

The effective reproduction number (different to basic reproduction number) reflects the current state of a population, which may include some infections. 

This is what we are estimating.

**What does this mean?**

If the R0 number is 1, this means that one person arriving to a population could spread it to one other person. Those people could then spread it to one other person. This is easier to manage. 

If R0 is 0.3, then for every 10 people infected, it would spread to 3 other people.

Both of these are good cases.

Now, some bad cases.

If the R0 number is 2, this means that every person arriving in the population can infect 2 more people. This can quickly get out of control.

We want the R0 to be below 1, and ideally as close to 0 as possible.

**Estimating Effective reproduction number**

We estimate the effective reproduction number using mathematical modelling. This means that the estimated numbers are dependent upon the mathematical model, and while they are our best possible guess at R0, they could be inaccurate.


**Misconceptions / mistakes**

It is not a rate, and has no units of time.
This means it is not a rate of infection, and does not tell us how fast an infection spreads.

**Limitations**

These estimates are for all countries do not account for people who bring the infection to the population by travelling. This means that we are assuming all of these infections are spread by the community. However, Australia actually has quite a large proportion of people who are travelling from overseas with COVID19. This means that these estimates might be over-estimating R0. We have explored what is possible if we improve incorporate these imported cases, where we have this data for New South Wales.


### Selected Countries


```{r covid-instant-repro}
covid_instant_r <- add_instant_reproduction(covid) %>% 
  # only look at dates from March
  filter(date > ymd("2020-03-01")) 
```


```{r gg-effective-repro-all, cache = FALSE, fig.height = 8, fig.width = 12, cache = FALSE}
  gg_effective_repro_all(covid_instant_r) + 
  theme(panel.grid.minor = element_blank())
  # ggthemes::scale_colour_colorblind() +
  # annotation_logticks() 
```


### Per Country

```{r gg-effective-r-facet, fig.height = 8, fig.width = 12}
covid_instant_r %>% 
  gg_effective_repro_facet()  + 
  theme(panel.grid.minor = element_blank())
```

### Per Country (ribbons)

```{r gg-effective-r-facet-ribbon, fig.height = 8, fig.width = 12}
covid_instant_r %>% 
  gg_effective_repro_facet()  + 
  geom_ribbon(aes(ymin = quantile_0_025_r,
                  ymax = quantile_0_975_r),
              alpha = 0.1,
              colour = "gray50") 
```


$R_{t}$ for NSW {.storyboard}
=======================================================================

### Explanation

The total number of incident cases arising at timestep $t$, $I_t$, is the sum of the numbers of incident local ($I_{t}^{local}$) and imported ($I_{t}^{imported}$) cases,

$$ I_t = I_t^{local} + I_t^{imported} $$

It is assumed that, if imported cases exist, they can be distinguished from local cases, for instance through epidemiological investigations, so that 
 $I_{t}^{local}$ and $I_{t}^{imported}$ are observed at each timestep.


$$\Lambda_t(w_s) = \sum_{s=1}^t (I_{t-s}^{local} + I_{t-s}^{imported}) w_s = \sum_{s=1}^t I_{t-s} w_s $$
$$ \mathbb E(I_t^{local} | I_0, I_1, \ldots, I_{t-1}, w_s, T_t) = R_t\Lambda_t (w_s)$$

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>parametric serial interval distribution

```{r nsw-local-os-sep, fig.width=10, fig.height=10}
A1a / A2a / A3a / A4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation excluded)<br>serial interval distribution estimated from data

```{r nsw-local-os-sep-est-si-dist, fig.width=10, fig.height=10}
A1b / A2b / A3b / A4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- adjusting for potential under-ascertainment, locally-acquired & overseas-acquired cases treated separately**, (cases under investigation excluded), parametric serial interval distribution

```{r nsw-adj-local-acquire-separately, fig.width=10, fig.height=10}
UA1a / UA2a / UA3a / UA4a + plot_layout(heights=c(2,1,1,1))
```

***

In these plots, the counts of incident cases with presumed local sources of infection have been inflated by a factor of 10, and the counts of cases with presumed overseas sources of infection inflated by a factor of 1.5. This mimics ten-fold under-ascertainment of locally-transmitted cases, and 50% under-ascertainment of inbound cases.

---

### **NSW -- adjusting for potential under-ascertainment, locally-acquired & overseas-acquired cases treated separately**, (cases under investigation excluded), serial interval distribution estimated from data

```{r nsw-adj-under-os-separately, fig.width=10, fig.height=10}
UA1b / UA2b / UA3b / UA4b + plot_layout(heights=c(2,1,1,1))
```

***

In these plots, the counts of incident cases with presumed local sources of infection have been inflated by a factor of 10, and the counts of cases with presumed overseas sources of infection inflated by a factor of 1.5. This mimics ten-fold under-ascertainment of locally-transmitted cases, and 50% under-ascertainment of inbound cases.

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>parametric serial interval distribution

```{r nsw-local-os-separately-paramtric, fig.width=10, fig.height=10}
B1a / B2a / B3a / B4a + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---

### **NSW -- locally-acquired & overseas-acquired cases treated separately**<br>(cases under investigation included)<br>serial interval distribution estimated from data

```{r nsw-local-os-sep-si-dist-data, fig.width=10, fig.height=10}
B1b / B2b / B3b / B4b + plot_layout(heights=c(2,1,1,1))
```

***

Commentary

---


### **NSW -- all cases treated as locally-acquired**<br>parametric serial interval distribution

```{r nsw-all-cases-locally, fig.width=10, fig.height=10,}
C1a / C2a / C3a + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---

### **NSW -- all cases treated as locally-acquired**<br>serial interval distribution estimated from data

```{r nsw-all-cases-locally-si-est-data, fig.width=10, fig.height=10,}
C1b / C2b / C3b + plot_layout(heights=c(2,1.5,1.5))
```

***

From data commentary blah blah blah.

---




